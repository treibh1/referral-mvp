<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Enrichment - Referral MVP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1200px;
            overflow: hidden;
        }
        
        .header-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header-section p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content-section {
            padding: 30px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #28a745;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .search-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .search-input-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 15px 15px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .contact-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .contact-details {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .selected-contact-card {
            background: white;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .selected-contact-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .selected-contact-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .selected-contact-info {
            color: #6c757d;
            font-size: 0.95rem;
        }
        
        .tag-section {
            margin: 20px 0;
        }
        
        .tag-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .tag-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tag-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .tag-btn.selected {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-color: #007bff;
        }
        
        .notes-section {
            margin: 20px 0;
        }
        
        .notes-textarea {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .notes-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(108,117,125,0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .progress-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #28a745, #20c997);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .achievement-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .tagged-contacts-section {
            margin-top: 30px;
        }
        
        .tagged-contact-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
        
        .tagged-contact-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .tagged-contact-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .contact-tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
                 .contact-tag.highlighted {
             background: linear-gradient(135deg, #28a745, #20c997);
             color: white;
         }
         
         .selected-contacts-list {
             margin: 15px 0;
         }
         
         .selected-contact-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             background: #f8f9fa;
             border: 1px solid #dee2e6;
             border-radius: 10px;
             padding: 12px;
             margin-bottom: 8px;
         }
         
         .contact-info {
             flex-grow: 1;
         }
         
         .search-result-item .contact-name.selected {
             color: #28a745;
             font-weight: 700;
         }
         
                   .selected-people-container {
              margin: 15px 0;
          }
          
                     .selected-person-row {
               margin: 8px 0;
               padding: 10px 15px;
               background: #f8f9fa;
               border: 2px solid #28a745;
               border-radius: 10px;
               text-align: left;
               position: relative;
           }
           
           .selected-person-content {
               display: flex;
               flex-direction: column;
               align-items: flex-start;
               gap: 2px;
           }
          
          .selected-person-content span:first-child {
              font-weight: 600;
              color: #2c3e50;
              font-size: 1.1rem;
          }
          
          .selected-person-details {
              color: #6c757d;
              font-size: 0.9rem;
          }
          
          .remove-person-btn {
              position: absolute;
              top: 5px;
              right: 10px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 50%;
              width: 24px;
              height: 24px;
              font-size: 14px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              line-height: 1;
          }
          
          .remove-person-btn:hover {
              background: #c82333;
          }
         
         .language-section {
             margin: 15px 0;
             padding: 15px;
             background: #f8f9fa;
             border-radius: 10px;
             border: 1px solid #dee2e6;
         }
         
         .language-buttons {
             display: flex;
             flex-wrap: wrap;
             gap: 8px;
             margin-top: 10px;
         }
         
         .language-btn {
             background: #f8f9fa;
             border: 2px solid #dee2e6;
             border-radius: 20px;
             padding: 6px 12px;
             font-size: 0.9rem;
             cursor: pointer;
             transition: all 0.2s ease;
         }
         
         .language-btn:hover {
             background: #e9ecef;
             border-color: #adb5bd;
         }
         
         .language-btn.selected {
             background: linear-gradient(135deg, #007bff, #0056b3);
             color: white;
             border-color: #007bff;
         }
         
         .loading-spinner {
             text-align: center;
             padding: 20px;
             color: #6c757d;
         }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header-section {
                padding: 20px;
            }
            
            .header-section h1 {
                font-size: 2rem;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .tag-buttons {
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-section">
            <h1>🎯 Contact Enrichment</h1>
            <p>Help us identify the best people in your network!</p>
        </div>
        
        <div class="content-section">
            <!-- Progress Section -->
            <div class="progress-section">
                <h4>📊 Your Progress</h4>
                <div class="row">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="taggedCount">0</div>
                            <div class="stats-label">Contacts Tagged</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="totalContacts">0</div>
                            <div class="stats-label">Total Contacts</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-number" id="completionPercent">0%</div>
                            <div class="stats-label">Completion</div>
                        </div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            
                         <!-- Search Section -->
             <div class="search-section">
                 <h4>🔍 <span id="currentQuestion">Who's the best person you've worked with?</span></h4>
                 <p class="text-muted mb-4">Start typing a name to find and tag someone special in your network</p>
                 
                 <div class="search-input-container">
                     <div class="d-flex gap-2 align-items-center">
                         <div class="flex-grow-1 position-relative">
                             <input type="text" 
                                    class="search-input" 
                                    id="contactSearch" 
                                    placeholder="Type a name (minimum 3 characters)..."
                                    autocomplete="off">
                             <div class="search-dropdown" id="searchDropdown"></div>
                         </div>
                         <button class="btn btn-primary btn-sm" id="multiSelectBtn" onclick="toggleMultiSelectMode()">
                             👥 Add More Than 1 Person
                         </button>
                     </div>
                 </div>
                 
                                   <!-- Selected People Rows -->
                  <div id="selectedPeopleContainer" class="selected-people-container" style="display: none;">
                      <!-- Individual selected person rows will be added here -->
                  </div>
                  
                  <!-- Language Section (for language questions) -->
                  <div id="languageSection" class="language-section" style="display: none;">
                      <h6>What languages do they speak?</h6>
                      <div class="language-buttons">
                          <!-- Language buttons will be generated here -->
                      </div>
                  </div>
                  
                  <div class="text-center">
                      <button class="btn btn-secondary" onclick="skipCurrentQuestion()">
                          ⏭️ Skip This Question
                      </button>
                      <button class="btn btn-success" id="submitBtn" onclick="saveContactTags()" style="display: none;">
                          💾 Submit
                      </button>
                  </div>
             </div>
            
            
            
            <!-- Tagged Contacts Section -->
            <div class="tagged-contacts-section" id="taggedContactsSection" style="display: none;">
                <h4>🏆 Your Tagged Contacts</h4>
                <div id="taggedContactsList"></div>
            </div>
            
            <!-- Navigation -->
            <div class="navigation-buttons">
                <button class="btn btn-secondary" onclick="goBack()">← Back</button>
                <button class="btn btn-primary" onclick="continueToJobSearch()">Continue to Job Search →</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize variables
        let selectedContact = null;
        let selectedTags = [];
        let contactTags = JSON.parse(localStorage.getItem('contactTags') || '{}');
        let taggedContacts = Object.keys(contactTags).length;
        let allContacts = [];
        let currentRole = '';
        let selectedContacts = []; // Array to hold multiple selected contacts
        let isMultiSelectMode = false; // Track if we're in multi-select mode
        let currentQuestionIndex = 0; // Track current question
        let selectedLanguages = []; // For language questions
        
        // Questions bank
        const questions = [
            "Who's the best person you've worked with?",
            "Who's the most reliable team member you know?",
            "Who would you trust with a critical project?",
            "Who's the most innovative person in your network?",
            "Who's the best problem solver you've worked with?",
            "Who's the most collaborative person you know?",
            "Who would you recommend for a leadership role?",
            "Who's the most detail-oriented person you know?",
            "Who's the best communicator in your network?",
            "Who would you want on your team for any project?",
            "Do you know any French speaking Sales people?",
            "Do you know any multi-language sales people?"
        ];
        
        // Language options
        const languages = [
            "French", "Spanish", "German", "Italian", "Portuguese", 
            "Chinese (Mandarin)", "Chinese (Cantonese)", "Japanese", "Korean", 
            "Arabic", "Russian", "Hindi", "Dutch", "Swedish", "Norwegian",
            "Danish", "Finnish", "Polish", "Czech", "Hungarian", "Turkish",
            "Greek", "Hebrew", "Thai", "Vietnamese", "Indonesian", "Malay"
        ];
        
                 // Initialize page
         document.addEventListener('DOMContentLoaded', function() {
             loadContacts();
             initializeSearch();
             displayTaggedContacts();
             updateQuestion();
         });
         
         // Function to normalize strings for accent-insensitive search
         function normalizeString(str) {
             return str.toLowerCase()
                 .normalize('NFD')
                 .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                 .replace(/[^\w\s]/g, ''); // Remove special characters
         }
        
        function updateQuestion() {
            const questionElement = document.getElementById('currentQuestion');
            if (questionElement) {
                questionElement.textContent = questions[currentQuestionIndex];
            }
            
            // Show/hide language selector based on question type
            const languageSection = document.getElementById('languageSection');
            if (languageSection) {
                const isLanguageQuestion = currentQuestionIndex >= 10; // Questions 10 and 11 are language questions
                languageSection.style.display = isLanguageQuestion ? 'block' : 'none';
            }
        }
        
        function nextQuestion() {
            currentQuestionIndex = (currentQuestionIndex + 1) % questions.length;
            updateQuestion();
            clearSelection();
        }
        
        function previousQuestion() {
            currentQuestionIndex = currentQuestionIndex === 0 ? questions.length - 1 : currentQuestionIndex - 1;
            updateQuestion();
            clearSelection();
        }
        
        function loadContacts() {
            // Show loading
            document.getElementById('totalContacts').textContent = 'Loading...';
            
            // Fetch contacts from backend
            fetch('/api/contacts')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.contacts) {
                        allContacts = data.contacts.map(contact => ({
                            name: `${contact['First Name']} ${contact['Last Name']}`,
                            position: contact['Position'] || 'N/A',
                            company: contact['Company'] || 'N/A',
                            location: contact['Location'] || 'N/A',
                            email: contact['Email'] || '',
                            phone: contact['Phone'] || '',
                            linkedin: contact['LinkedIn'] || ''
                        }));
                        
                        updateStats();
                    } else {
                        console.error('Failed to load contacts:', data);
                        document.getElementById('totalContacts').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    document.getElementById('totalContacts').textContent = 'Error';
                });
        }
        
        function updateStats() {
            const totalContacts = allContacts.length;
            const completionPercent = totalContacts > 0 ? Math.round((taggedContacts / totalContacts) * 100) : 0;
            
            document.getElementById('taggedCount').textContent = taggedContacts;
            document.getElementById('totalContacts').textContent = totalContacts;
            document.getElementById('completionPercent').textContent = completionPercent + '%';
            document.getElementById('progressFill').style.width = completionPercent + '%';
        }
        
        function initializeTagButtons() {
            const tagButtons = document.querySelectorAll('.tag-btn');
            tagButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateSelectedTags();
                });
            });
        }
        
        function updateSelectedTags() {
            // Get selected tags from both sets of buttons
            const allSelectedButtons = document.querySelectorAll('.tag-btn.selected');
            selectedTags = Array.from(allSelectedButtons).map(btn => btn.dataset.tag);
        }
        

        
        function initializeSearch() {
            const searchInput = document.getElementById('contactSearch');
            const dropdown = document.getElementById('searchDropdown');
            let currentFocus = -1;
            let filteredContacts = [];
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 3) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                                 // Filter contacts with accent-insensitive search
                 filteredContacts = allContacts.filter(contact => {
                     const normalizedQuery = normalizeString(query);
                     const normalizedName = normalizeString(contact.name);
                     const normalizedCompany = normalizeString(contact.company);
                     const normalizedPosition = normalizeString(contact.position);
                     
                     return normalizedName.includes(normalizedQuery) ||
                            normalizedCompany.includes(normalizedQuery) ||
                            normalizedPosition.includes(normalizedQuery);
                 });
                 
                 // Sort results to prioritize name matches
                 filteredContacts.sort((a, b) => {
                     const normalizedQuery = normalizeString(query);
                     const aName = normalizeString(a.name);
                     const bName = normalizeString(b.name);
                     const aCompany = normalizeString(a.company);
                     const bCompany = normalizeString(b.company);
                     const aPosition = normalizeString(a.position);
                     const bPosition = normalizeString(b.position);
                     
                     // Check if name starts with query (highest priority)
                     const aNameStartsWith = aName.startsWith(normalizedQuery);
                     const bNameStartsWith = bName.startsWith(normalizedQuery);
                     
                     if (aNameStartsWith && !bNameStartsWith) return -1;
                     if (!aNameStartsWith && bNameStartsWith) return 1;
                     
                     // Check if name contains query (second priority)
                     const aNameContains = aName.includes(normalizedQuery);
                     const bNameContains = bName.includes(normalizedQuery);
                     
                     if (aNameContains && !bNameContains) return -1;
                     if (!aNameContains && bNameContains) return 1;
                     
                     // If both have name matches, sort alphabetically
                     if (aNameContains && bNameContains) {
                         return aName.localeCompare(bName);
                     }
                     
                     // Company/position matches (lowest priority)
                     const aCompanyContains = aCompany.includes(normalizedQuery);
                     const bCompanyContains = bCompany.includes(normalizedQuery);
                     const aPositionContains = aPosition.includes(normalizedQuery);
                     const bPositionContains = bPosition.includes(normalizedQuery);
                     
                     if (aCompanyContains && !bCompanyContains) return -1;
                     if (!aCompanyContains && bCompanyContains) return 1;
                     if (aPositionContains && !bPositionContains) return -1;
                     if (!aPositionContains && bPositionContains) return 1;
                     
                     // If all else is equal, sort by name
                     return aName.localeCompare(bName);
                 });
                
                if (filteredContacts.length > 0) {
                    displaySearchResults(filteredContacts);
                    currentFocus = -1;
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.search-result-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus = (currentFocus + 1) % items.length;
                    updateFocus(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus = currentFocus <= 0 ? items.length - 1 : currentFocus - 1;
                    updateFocus(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus >= 0 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    currentFocus = -1;
                }
            });
            
            function updateFocus(items) {
                items.forEach((item, index) => {
                    if (index === currentFocus) {
                        item.style.backgroundColor = '#007bff';
                        item.style.color = 'white';
                    } else {
                        item.style.backgroundColor = '';
                        item.style.color = '';
                    }
                });
            }
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                    currentFocus = -1;
                }
            });
            
            // Initialize language buttons
            initializeLanguageButtons();
        }
        
        function initializeLanguageButtons() {
            const languageButtons = document.querySelector('.language-buttons');
            if (languageButtons) {
                languageButtons.innerHTML = '';
                languages.forEach(lang => {
                    const btn = document.createElement('button');
                    btn.className = 'language-btn';
                    btn.textContent = lang;
                    btn.addEventListener('click', function() {
                        this.classList.toggle('selected');
                        updateSelectedLanguages();
                    });
                    languageButtons.appendChild(btn);
                });
            }
        }
        
        function updateSelectedLanguages() {
            const selectedButtons = document.querySelectorAll('.language-btn.selected');
            selectedLanguages = Array.from(selectedButtons).map(btn => btn.textContent);
        }
        
        function displaySearchResults(contacts) {
            const dropdown = document.getElementById('searchDropdown');
            dropdown.innerHTML = '';
            
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                // Check if contact is already selected in multi-select mode
                const isSelected = selectedContacts.some(sc => sc.name === contact.name);
                const selectedClass = isSelected ? 'selected' : '';
                
                item.innerHTML = `
                    <div class="contact-name ${selectedClass}">${contact.name}</div>
                    <div class="contact-details">${contact.position} at ${contact.company}</div>
                    ${isSelected ? '<small class="text-success">✓ Selected</small>' : ''}
                `;
                
                item.addEventListener('click', () => selectContact(contact));
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }
        
                 function selectContact(contact) {
             if (isMultiSelectMode) {
                 // Multi-select mode: add/remove from selected contacts
                 const existingIndex = selectedContacts.findIndex(sc => sc.name === contact.name);
                 if (existingIndex >= 0) {
                     selectedContacts.splice(existingIndex, 1);
                 } else if (selectedContacts.length < 3) {
                     selectedContacts.push(contact);
                 } else {
                     showNotification('❌ You can only select up to 3 people per question!', 'warning');
                     return;
                 }
                 
                 // Update display
                 updateSelectedPeopleDisplay();
                 document.getElementById('searchDropdown').style.display = 'none';
                 document.getElementById('contactSearch').value = '';
                 
                 showNotification(`✅ ${selectedContacts.length} people selected`, 'success');
             } else {
                 // Single select mode
                 selectedContact = contact;
                 currentRole = contact.position;
                 
                 // Update display for single person
                 updateSelectedPeopleDisplay();
                 document.getElementById('searchDropdown').style.display = 'none';
                 document.getElementById('contactSearch').value = '';
             }
         }
        
                 function updateSelectedPeopleDisplay() {
             const container = document.getElementById('selectedPeopleContainer');
             const submitBtn = document.getElementById('submitBtn');
             
             // Clear the container
             container.innerHTML = '';
             
             // Get all contacts to display (either selectedContacts or single selectedContact)
             const contactsToShow = isMultiSelectMode ? selectedContacts : (selectedContact ? [selectedContact] : []);
             
             if (contactsToShow.length === 0) {
                 container.style.display = 'none';
                 submitBtn.style.display = 'none';
                 return;
             }
             
             // Show each selected person as a separate row
             contactsToShow.forEach((contact, index) => {
                 const personRow = document.createElement('div');
                 personRow.className = 'selected-person-row';
                 personRow.innerHTML = `
                     <div class="selected-person-content">
                         <span>${contact.name}</span>
                         <span class="selected-person-details">(${contact.position} at ${contact.company})</span>
                     </div>
                     ${isMultiSelectMode ? `<button class="remove-person-btn" onclick="removeSelectedPerson(${index})">×</button>` : ''}
                 `;
                 container.appendChild(personRow);
             });
             
             container.style.display = 'block';
             submitBtn.style.display = 'inline-block';
         }
        

        

        
        function toggleMultiSelectMode() {
            isMultiSelectMode = !isMultiSelectMode;
            const button = document.getElementById('multiSelectBtn');
            
            if (isMultiSelectMode) {
                button.textContent = '👤 Single Person';
                button.className = 'btn btn-outline-primary btn-sm';
                document.getElementById('contactSearch').placeholder = 'Select up to 3 people...';
                showNotification('🔍 Multi-select mode: Click people to add them (max 3)', 'info');
            } else {
                button.textContent = '👥 Add More Than 1 Person';
                button.className = 'btn btn-primary btn-sm';
                document.getElementById('contactSearch').placeholder = 'Type a name (minimum 3 characters)...';
                selectedContacts = [];
                updateSelectedPeopleDisplay();
                showNotification('👤 Single-select mode: Click one person to select', 'info');
            }
        }
        
        function saveContactTags() {
            if (isMultiSelectMode) {
                // Multi-select mode
                if (selectedContacts.length === 0) {
                    alert('Please select at least one person.');
                    return;
                }
                
                // Get question-based tag
                const questionTag = getQuestionTag();
                
                // Save tags for all selected contacts
                selectedContacts.forEach(contact => {
                    contactTags[contact.name] = {
                        tags: [questionTag],
                        languages: selectedLanguages,
                        question: questions[currentQuestionIndex],
                        role: currentRole || 'Multiple Roles',
                        taggedAt: new Date().toISOString()
                    };
                });
                
                // Update localStorage
                localStorage.setItem('contactTags', JSON.stringify(contactTags));
                
                // Update stats
                taggedContacts = Object.keys(contactTags).length;
                updateStats();
                
                // Show success message
                showNotification(`✅ Tagged ${selectedContacts.length} people for: ${questions[currentQuestionIndex]}`, 'success');
                
                // Reset and move to next question
                selectedContacts = [];
                selectedLanguages = [];
                updateSelectedPeopleDisplay();
                document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('selected'));
                
                // Update tagged contacts display
                displayTaggedContacts();
                
                // Move to next question
                nextQuestion();
                
            } else {
                // Single select mode
                if (!selectedContact) {
                    alert('No contact selected. Please search for a contact first.');
                    return;
                }
                
                // Get question-based tag
                const questionTag = getQuestionTag();
                
                // Save tags
                contactTags[selectedContact.name] = {
                    tags: [questionTag],
                    languages: selectedLanguages,
                    question: questions[currentQuestionIndex],
                    role: currentRole,
                    taggedAt: new Date().toISOString()
                };
                
                // Update localStorage
                localStorage.setItem('contactTags', JSON.stringify(contactTags));
                
                // Update stats
                taggedContacts = Object.keys(contactTags).length;
                updateStats();
                
                // Show success message
                showNotification(`✅ Tagged ${selectedContact.name} for: ${questions[currentQuestionIndex]}`, 'success');
                
                                 // Hide container and reset
                 document.getElementById('selectedPeopleContainer').style.display = 'none';
                 selectedContact = null;
                 selectedLanguages = [];
                 document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('selected'));
                
                // Update tagged contacts display
                displayTaggedContacts();
                
                // Move to next question
                nextQuestion();
            }
        }
        
        function getQuestionTag() {
            // Generate tag based on current question
            const question = questions[currentQuestionIndex];
            if (question.includes('best person')) return 'best-person';
            if (question.includes('reliable')) return 'reliable';
            if (question.includes('trust')) return 'trustworthy';
            if (question.includes('innovative')) return 'innovative';
            if (question.includes('problem solver')) return 'problem-solver';
            if (question.includes('collaborative')) return 'collaborative';
            if (question.includes('leadership')) return 'leadership';
            if (question.includes('detail-oriented')) return 'detail-oriented';
            if (question.includes('communicator')) return 'communicator';
            if (question.includes('team')) return 'team-player';
            if (question.includes('French')) return 'french-speaking';
            if (question.includes('multi-language')) return 'multi-lingual';
            return 'tagged';
        }
        
        function skipCurrentQuestion() {
            // Clear current selection and reset search
            selectedContact = null;
            selectedContacts = [];
            selectedLanguages = [];
            currentRole = '';
            isMultiSelectMode = false;
            
                         // Reset UI
             document.getElementById('selectedPeopleContainer').style.display = 'none';
             document.getElementById('submitBtn').style.display = 'none';
             document.getElementById('contactSearch').value = '';
             document.getElementById('searchDropdown').style.display = 'none';
             document.getElementById('contactSearch').placeholder = 'Type a name (minimum 3 characters)...';
            
            // Reset multi-select button
            const button = document.getElementById('multiSelectBtn');
            button.textContent = '👥 Add More Than 1 Person';
            button.className = 'btn btn-primary btn-sm';
            
            // Reset language buttons
            document.querySelectorAll('.language-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Move to next question
            nextQuestion();
            
            showNotification('⏭️ Skipped this question. Moving to next question!', 'info');
        }
        
                 function removeSelectedPerson(index) {
             if (isMultiSelectMode) {
                 selectedContacts.splice(index, 1);
                 updateSelectedPeopleDisplay();
                 showNotification('✅ Person removed', 'info');
             }
         }
         
         function clearSelection() {
             selectedContact = null;
             selectedContacts = [];
             selectedLanguages = [];
             document.getElementById('selectedPeopleContainer').style.display = 'none';
             document.getElementById('submitBtn').style.display = 'none';
             document.getElementById('contactSearch').value = '';
             document.getElementById('searchDropdown').style.display = 'none';
         }
        
        function displayTaggedContacts() {
            const section = document.getElementById('taggedContactsSection');
            const list = document.getElementById('taggedContactsList');
            
            if (taggedContacts === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            Object.entries(contactTags).forEach(([name, data]) => {
                const item = document.createElement('div');
                item.className = 'tagged-contact-item';
                
                const tagLabels = {
                    'best-person': '👑 Best Person',
                    'reliable': '✅ Reliable',
                    'trustworthy': '🤝 Trustworthy',
                    'innovative': '💡 Innovative',
                    'problem-solver': '🔧 Problem Solver',
                    'collaborative': '🤝 Collaborative',
                    'leadership': '👑 Leadership',
                    'detail-oriented': '📋 Detail-Oriented',
                    'communicator': '💬 Communicator',
                    'team-player': '👥 Team Player',
                    'french-speaking': '🇫🇷 French Speaking',
                    'multi-lingual': '🌍 Multi-Lingual',
                    'tagged': '🏷️ Tagged'
                };
                
                const tagsHtml = data.tags.map(tag => {
                    return `<span class="contact-tag highlighted">${tagLabels[tag] || tag}</span>`;
                }).join('');
                
                const languagesHtml = data.languages && data.languages.length > 0 ? 
                    `<div class="tagged-contact-languages">
                        <small class="text-muted">Languages: ${data.languages.join(', ')}</small>
                    </div>` : '';
                
                item.innerHTML = `
                    <div class="tagged-contact-name">${name}</div>
                    <div class="tagged-contact-tags">${tagsHtml}</div>
                    ${data.question ? `<small class="text-muted">Question: ${data.question}</small>` : ''}
                    ${languagesHtml}
                `;
                
                list.appendChild(item);
            });
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function skipEnrichment() {
            if (confirm('Are you sure you want to skip contact enrichment? You can always come back later.')) {
                window.location.href = '/';
            }
        }
        
        function goBack() {
            window.history.back();
        }
        
        function continueToJobSearch() {
            window.location.href = '/';
        }
    </script>
</body>
</html>
